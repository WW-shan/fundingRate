<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>èµ„é‡‘è´¹ç‡å¥—åˆ©ç³»ç»Ÿ</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .header {
        background: white;
        border-radius: 10px;
        padding: 30px;
        margin-bottom: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header-content {
        flex: 1;
      }

      .header-content h1 {
        color: #667eea;
        font-size: 32px;
        margin-bottom: 5px;
      }

      .header-content .subtitle {
        color: #666;
        font-size: 14px;
      }

      .header-actions {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .last-update {
        font-size: 12px;
        color: #999;
        margin-right: 15px;
      }

      .logout-btn {
        padding: 10px 20px;
        background: #ef4444;
        color: white;
        text-decoration: none;
        border-radius: 5px;
        font-size: 14px;
        transition: all 0.3s;
        border: none;
        cursor: pointer;
      }

      .logout-btn:hover {
        background: #dc2626;
        transform: translateY(-2px);
      }

      .nav-menu {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        display: flex;
        gap: 10px;
      }

      .nav-menu a {
        padding: 10px 20px;
        background: #f3f4f6;
        color: #667eea;
        text-decoration: none;
        border-radius: 5px;
        transition: all 0.3s;
        font-size: 14px;
      }

      .nav-menu a:hover,
      .nav-menu a.active {
        background: #667eea;
        color: white;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s;
      }

      .stat-card:hover {
        transform: translateY(-5px);
      }

      .stat-icon {
        font-size: 24px;
        margin-bottom: 10px;
      }

      .stat-label {
        color: #666;
        font-size: 12px;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .stat-value {
        color: #333;
        font-size: 28px;
        font-weight: bold;
      }

      .stat-change {
        font-size: 12px;
        margin-top: 5px;
      }

      .stat-change.positive {
        color: #10b981;
      }

      .stat-change.negative {
        color: #ef4444;
      }

      .status-badge {
        display: inline-block;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
      }

      .status-running {
        background: #10b981;
        color: white;
      }
      .status-simulation {
        background: #fbbf24;
        color: white;
      }
      .status-error {
        background: #ef4444;
        color: white;
      }

      .charts-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .chart-card {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .chart-card h3 {
        color: #667eea;
        margin-bottom: 20px;
        font-size: 18px;
      }

      .recent-activity {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .recent-activity h3 {
        color: #667eea;
        margin-bottom: 20px;
        font-size: 18px;
      }

      .activity-item {
        padding: 15px;
        border-left: 3px solid #667eea;
        background: #f9fafb;
        margin-bottom: 10px;
        border-radius: 5px;
      }

      .activity-time {
        font-size: 12px;
        color: #999;
      }

      .activity-content {
        margin-top: 5px;
        color: #333;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }

      .empty-state {
        text-align: center;
        padding: 40px;
        color: #999;
      }

      .table-container {
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      table th {
        background: #f3f4f6;
        padding: 12px;
        text-align: left;
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
      }

      table td {
        padding: 12px;
        border-bottom: 1px solid #e5e7eb;
        font-size: 14px;
      }

      table tr:hover {
        background: #f9fafb;
      }

      .pnl-positive {
        color: #10b981;
        font-weight: bold;
      }

      .pnl-negative {
        color: #ef4444;
        font-weight: bold;
      }

      .data-status-panel {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .data-status-panel h3 {
        color: #667eea;
        margin-bottom: 20px;
        font-size: 18px;
        display: flex;
        align-items: center;
      }

      .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
        background: #10b981;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .exchange-status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }

      .exchange-status-card {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 15px;
        transition: all 0.3s;
      }

      .exchange-status-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .exchange-status-card h4 {
        color: #667eea;
        font-size: 16px;
        margin-bottom: 10px;
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .exchange-status-card .data-count {
        font-size: 32px;
        font-weight: bold;
        color: #1f2937;
        margin: 10px 0;
      }

      .exchange-status-card .symbol-list {
        font-size: 12px;
        color: #6b7280;
        margin-top: 8px;
        line-height: 1.6;
      }

      .collector-status {
        display: inline-flex;
        align-items: center;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }

      .collector-running {
        background: #d1fae5;
        color: #065f46;
      }

      .collector-stopped {
        background: #fee2e2;
        color: #991b1b;
      }

      @media (max-width: 768px) {
        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .charts-section {
          grid-template-columns: 1fr;
        }

        .exchange-status-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="header-content">
          <h1>ğŸš€ èµ„é‡‘è´¹ç‡å¥—åˆ©ç³»ç»Ÿ</h1>
          <p class="subtitle">Funding Rate Arbitrage System v1.0.0</p>
        </div>
        <div class="header-actions">
          <span class="last-update" id="last-update">æœ€åæ›´æ–°: --</span>
          <a href="/logout" class="logout-btn">é€€å‡ºç™»å½•</a>
        </div>
      </div>

      <div class="nav-menu">
        <a href="/" class="active">ğŸ“Š ä»ªè¡¨ç›˜</a>
        <a href="/opportunities">ğŸ¯ æœºä¼šç›‘æ§</a>
        <a href="/positions">ğŸ’¼ æŒä»“ç®¡ç†</a>
        <a href="/config">âš™ï¸ ç³»ç»Ÿé…ç½®</a>
      </div>

      <!-- æ•°æ®é‡‡é›†çŠ¶æ€ -->
      <div class="data-status-panel">
        <h3>
          <span class="status-indicator"></span>
          æ•°æ®é‡‡é›†çŠ¶æ€
        </h3>
        <div id="data-status-content" class="loading">åŠ è½½ä¸­...</div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">ğŸŸ¢</div>
          <div class="stat-label">ç³»ç»ŸçŠ¶æ€</div>
          <div class="stat-value">
            <span class="status-badge" id="status-badge">åŠ è½½ä¸­...</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">ğŸ’¼</div>
          <div class="stat-label">å½“å‰æŒä»“</div>
          <div class="stat-value" id="open-positions">-</div>
          <div class="stat-change" id="positions-change"></div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">ğŸ’°</div>
          <div class="stat-label">æ€»ç›ˆäº</div>
          <div class="stat-value" id="total-pnl">-</div>
          <div class="stat-change" id="pnl-change"></div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">ğŸ¦</div>
          <div class="stat-label">äº¤æ˜“æ‰€è¿æ¥</div>
          <div class="stat-value" id="exchanges">-</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">ğŸ“ˆ</div>
          <div class="stat-label">ç›‘æ§äº¤æ˜“å¯¹</div>
          <div class="stat-value" id="symbols">-</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">âš¡</div>
          <div class="stat-label">ä»Šæ—¥äº¤æ˜“</div>
          <div class="stat-value" id="today-trades">-</div>
        </div>
      </div>

      <div class="charts-section">
        <div class="chart-card">
          <h3>ğŸ“Š æŒä»“æ¦‚è§ˆ</h3>
          <div id="positions-chart">
            <div class="loading">åŠ è½½ä¸­...</div>
          </div>
        </div>

        <div class="chart-card">
          <h3>ğŸ’¹ ç›ˆäºç»Ÿè®¡</h3>
          <div id="pnl-chart">
            <div class="loading">åŠ è½½ä¸­...</div>
          </div>
        </div>
      </div>

      <div class="recent-activity">
        <h3>ğŸ•’ æœ€è¿‘æ´»åŠ¨</h3>
        <div id="recent-activity">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>

    <script>
      let lastPositionCount = 0;

      function updateTime() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString("zh-CN");
        document.getElementById("last-update").textContent =
          `æœ€åæ›´æ–°: ${timeStr}`;
      }

      async function loadStatus() {
        try {
          const response = await fetch("/api/status");
          const data = await response.json();

          const statusBadge = document.getElementById("status-badge");
          if (data.status === "running") {
            if (data.trading_enabled) {
              statusBadge.textContent = "âœ… å®ç›˜è¿è¡Œ";
              statusBadge.className = "status-badge status-running";
            } else {
              statusBadge.textContent = "âš ï¸ æ¨¡æ‹Ÿæ¨¡å¼";
              statusBadge.className = "status-badge status-simulation";
            }
          } else {
            statusBadge.textContent = "âŒ å¼‚å¸¸";
            statusBadge.className = "status-badge status-error";
          }

          document.getElementById("exchanges").textContent =
            data.exchanges_connected || 0;
          document.getElementById("symbols").textContent =
            data.market_data_symbols || 0;
        } catch (error) {
          console.error("Failed to load status:", error);
          const statusBadge = document.getElementById("status-badge");
          statusBadge.textContent = "âŒ è¿æ¥å¤±è´¥";
          statusBadge.className = "status-badge status-error";
        }
      }

      async function loadPositions() {
        try {
          const response = await fetch("/api/positions");
          const result = await response.json();

          if (result.success) {
            const positions = result.data;
            const posCount = positions.length;

            document.getElementById("open-positions").textContent = posCount;

            // æ˜¾ç¤ºå˜åŒ–
            if (lastPositionCount > 0 && posCount !== lastPositionCount) {
              const change = posCount - lastPositionCount;
              const changeEl = document.getElementById("positions-change");
              changeEl.textContent = change > 0 ? `+${change}` : change;
              changeEl.className =
                change > 0 ? "stat-change positive" : "stat-change negative";
            }
            lastPositionCount = posCount;

            // è®¡ç®—æ€»ç›ˆäº
            let totalPnl = 0;
            positions.forEach((pos) => {
              totalPnl += parseFloat(pos.current_pnl || 0);
            });

            const pnlEl = document.getElementById("total-pnl");
            pnlEl.textContent = totalPnl.toFixed(2) + " USDT";
            pnlEl.className =
              "stat-value " + (totalPnl >= 0 ? "pnl-positive" : "pnl-negative");

            // æ¸²æŸ“æŒä»“å›¾è¡¨
            renderPositionsChart(positions);
            renderPnlChart(positions);
          } else {
            document.getElementById("open-positions").textContent = "0";
            document.getElementById("total-pnl").textContent = "0.00 USDT";
          }
        } catch (error) {
          console.error("Failed to load positions:", error);
        }
      }

      function renderPositionsChart(positions) {
        const container = document.getElementById("positions-chart");

        if (positions.length === 0) {
          container.innerHTML = '<div class="empty-state">æš‚æ— æŒä»“æ•°æ®</div>';
          return;
        }

        // æŒ‰ç­–ç•¥åˆ†ç»„
        const byStrategy = {};
        positions.forEach((pos) => {
          const strategy = pos.strategy_type || "unknown";
          byStrategy[strategy] = (byStrategy[strategy] || 0) + 1;
        });

        let html =
          "<table><thead><tr><th>ç­–ç•¥</th><th>æŒä»“æ•°</th><th>å æ¯”</th></tr></thead><tbody>";

        Object.entries(byStrategy).forEach(([strategy, count]) => {
          const percent = ((count / positions.length) * 100).toFixed(1);
          html += `<tr>
                    <td>${strategy}</td>
                    <td>${count}</td>
                    <td>${percent}%</td>
                </tr>`;
        });

        html += "</tbody></table>";
        container.innerHTML = html;
      }

      function renderPnlChart(positions) {
        const container = document.getElementById("pnl-chart");

        if (positions.length === 0) {
          container.innerHTML = '<div class="empty-state">æš‚æ— ç›ˆäºæ•°æ®</div>';
          return;
        }

        let profitable = 0;
        let losing = 0;

        positions.forEach((pos) => {
          const pnl = parseFloat(pos.current_pnl || 0);
          if (pnl > 0) profitable++;
          else if (pnl < 0) losing++;
        });

        const total = positions.length;
        const profitRate = ((profitable / total) * 100).toFixed(1);

        let html =
          "<table><thead><tr><th>ç±»å‹</th><th>æ•°é‡</th><th>å æ¯”</th></tr></thead><tbody>";
        html += `<tr>
                <td style="color: #10b981;">ç›ˆåˆ©</td>
                <td>${profitable}</td>
                <td>${profitRate}%</td>
            </tr>`;
        html += `<tr>
                <td style="color: #ef4444;">äºæŸ</td>
                <td>${losing}</td>
                <td>${((losing / total) * 100).toFixed(1)}%</td>
            </tr>`;
        html += `<tr>
                <td>æŒå¹³</td>
                <td>${total - profitable - losing}</td>
                <td>${(((total - profitable - losing) / total) * 100).toFixed(1)}%</td>
            </tr>`;
        html += "</tbody></table>";

        container.innerHTML = html;
      }

      async function loadRecentActivity() {
        try {
          const response = await fetch("/api/positions");
          const result = await response.json();

          if (result.success && result.data.length > 0) {
            const positions = result.data.slice(0, 5); // æœ€è¿‘5ä¸ª

            let html = "";
            positions.forEach((pos) => {
              const pnl = parseFloat(pos.current_pnl || 0);
              const pnlClass = pnl >= 0 ? "pnl-positive" : "pnl-negative";

              html += `<div class="activity-item">
                            <div class="activity-time">${pos.open_time || "-"}</div>
                            <div class="activity-content">
                                <strong>${pos.symbol}</strong> - ${pos.strategy_type}
                                <span class="${pnlClass}" style="float: right;">
                                    ${pnl >= 0 ? "+" : ""}${pnl.toFixed(2)} USDT
                                </span>
                            </div>
                        </div>`;
            });

            document.getElementById("recent-activity").innerHTML = html;
          } else {
            document.getElementById("recent-activity").innerHTML =
              '<div class="empty-state">æš‚æ— æ´»åŠ¨è®°å½•</div>';
          }
        } catch (error) {
          console.error("Failed to load recent activity:", error);
        }
      }

      async function loadTodayTrades() {
        // ç®€åŒ–ç‰ˆï¼šä½¿ç”¨æŒä»“æ•°æ®
        document.getElementById("today-trades").textContent =
          lastPositionCount || "0";
      }

      // åŠ è½½æ•°æ®é‡‡é›†çŠ¶æ€
      async function loadDataStatus() {
        try {
          const response = await fetch("/api/exchanges/status");
          const result = await response.json();

          if (result.success) {
            const data = result.data;
            let html = "";

            // é‡‡é›†å™¨çŠ¶æ€æ€»è§ˆ
            const collectorStatus = data.collector_running
              ? '<span class="collector-status collector-running">âœ… è¿è¡Œä¸­</span>'
              : '<span class="collector-status collector-stopped">âŒ å·²åœæ­¢</span>';

            html += `<div style="margin-bottom: 20px; display: flex; gap: 20px; align-items: center;">`;
            html += `<div>é‡‡é›†å™¨: ${collectorStatus}</div>`;
            html += `<div style="color: #667eea; font-weight: 600;">ç›‘æ§äº¤æ˜“å¯¹: ${data.total_symbols} ä¸ª</div>`;
            html += `</div>`;

            // å„äº¤æ˜“æ‰€çŠ¶æ€
            if (data.exchanges && data.exchanges.length > 0) {
              html += '<div class="exchange-status-grid">';

              data.exchanges.forEach((ex) => {
                const statusIcon = ex.symbols_count > 0 ? "ğŸŸ¢" : "ğŸ”´";
                html += `
                                <div class="exchange-status-card">
                                    <h4>${statusIcon} ${ex.exchange.toUpperCase()}</h4>
                                    <div class="data-count">${ex.symbols_count}</div>
                                    <div style="font-size: 12px; color: #6b7280;">ä¸ªäº¤æ˜“å¯¹æ•°æ®</div>
                                    ${
                                      ex.symbols.length > 0
                                        ? `<div class="symbol-list">${ex.symbols.join(" Â· ")}</div>`
                                        : '<div class="symbol-list" style="color: #ef4444;">æš‚æ— æ•°æ®</div>'
                                    }
                                </div>
                            `;
              });

              html += "</div>";
            } else {
              html += '<div class="empty-state">æš‚æ— äº¤æ˜“æ‰€è¿æ¥</div>';
            }

            document.getElementById("data-status-content").innerHTML = html;
          } else {
            document.getElementById("data-status-content").innerHTML =
              '<div class="empty-state" style="color: #ef4444;">åŠ è½½å¤±è´¥</div>';
          }
        } catch (error) {
          console.error("åŠ è½½æ•°æ®çŠ¶æ€å¤±è´¥:", error);
          document.getElementById("data-status-content").innerHTML =
            '<div class="empty-state" style="color: #ef4444;">åŠ è½½å¤±è´¥: ' +
            error.message +
            "</div>";
        }
      }

      async function refreshAll() {
        updateTime();
        await Promise.all([
          loadStatus(),
          loadPositions(),
          loadRecentActivity(),
          loadTodayTrades(),
          loadDataStatus(),
        ]);
      }

      // åˆå§‹åŠ è½½
      refreshAll();

      // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡
      setInterval(refreshAll, 5000);
    </script>
  </body>
</html>
